# ゲームルール仕様（1レーンリアルタイムMVP）

## 盤面仕様

### レーン構造
- **レーン数**: 1本（1次元）
- **座標系**: 0-20（21マス）
- **プレイヤー側**: 0（左端）
- **AI側**: 20（右端）
- **中立地帯**: 1-19

```
0    1  2  3  4  5  ... 18 19 20
│    │  │  │  │  │      │  │  │
Player                      AI
Base                       Base
```

### 召喚ルール
- ユニットは自陣の座標0にのみ召喚可能
- AIは座標20に召喚
- 召喚はコストを消費
- 召喚位置に既にユニットがいても召喚可能（同じマスに複数ユニット可）

## 勝利条件

### メイン勝利条件
- **敵拠点HP=0**: 敵拠点のHPを0以下にする
- プレイヤー拠点HP: 初期値100
- AI拠点HP: 初期値100

### その他の終了条件
- 時間制限（オプション）
- 降参（MVP後）

## ユニット仕様

### 基本ステータス
各ユニットは以下のステータスを持つ:

| ステータス | 型 | 範囲 | 説明 |
|-----------|-----|------|------|
| **max_hp** | int | 5-30 | 最大体力 |
| **atk** | int | 1-15 | 攻撃力 |
| **speed** | float | 0.2-2.0 | 移動速度（マス/tick）|
| **range** | float | 1.0-7.0 | 攻撃可能な距離 |
| **atk_interval** | float | 1.0-5.0 | 攻撃間隔（秒） |
| **cost** | int | 1-8 | 召喚に必要なコスト |

### 画像アセット
各ユニットは以下の画像を持つ:

| 画像種別 | サイズ | 用途 | 生成タイミング |
|---------|--------|------|--------------|
| **スプライト** | 32×32px | ゲーム内のユニット表示 | ユニット生成時（1回のみ） |
| **カード絵** | 256×256px | デッキ・ギャラリー表示 | ユニット生成時（1回のみ） |

画像は以下の方法で生成される:
1. プロンプトからユニット名・特徴を抽出
2. 画像プロンプトを自動生成（例: "pixel art, 32x32, ninja character, black outfit, fast movement"）
3. Mistral Image API（Pixtral Large）で画像生成
4. ローカルストレージに保存（`server/static/sprites/{unit_id}.png`, `server/static/cards/{unit_id}.png`）
5. URL生成（`http://localhost:8000/static/sprites/{unit_id}.png`）

### ユニットインスタンス
試合中のユニットは以下の状態を持つ:
- **instance_id**: ユニット識別子
- **spec_id**: UnitSpec参照
- **side**: "player" | "ai"
- **hp**: 現在HP
- **pos**: 現在位置（float、描画時に丸める）
- **cooldown_remaining**: 攻撃クールダウン（秒）

## コストシステム

### コスト管理
- **初期コスト**: 10
- **コスト上限**: 20
- **回復レート**: +3秒 = +0.6/tick（200ms）
- コストは時間経過で自動回復

### コスト計算例
```
開始: 10コスト
+1秒: 10 + 0.333 = 10.333
+3秒: 10 + 1 = 11
+30秒: 10 + 10 = 20（上限到達）
```

### デッキ制約
- デッキサイズ: 5体（固定）
- 各ユニットのコストは1-8
- 全て異なるユニット（重複不可）

## リアルタイムtickシステム

### tick仕様
- **tick間隔**: 200ms
- **処理順序**:
  1. 移動処理
  2. 攻撃処理
  3. ダメージ適用
  4. 死亡判定
  5. 拠点ダメージ判定
  6. コスト回復
  7. 勝敗判定

### 移動処理
- 各ユニットは自動的に敵陣に向かって前進
- プレイヤーユニット: pos += speed × 0.2（200ms分）
- AIユニット: pos -= speed × 0.2
- 移動範囲: 0-20にクランプ

### 攻撃処理
- 射程内に敵がいれば攻撃
- 攻撃クールダウンが0以下の場合のみ
- 攻撃後、cooldown_remaining = atk_interval にリセット
- ダメージ: atkの値をそのまま与える
- 最も近い敵を優先（複数いる場合）

### クールダウン更新
- 毎tick、cooldown_remaining -= 0.2（200ms）

### 死亡判定
- HP <= 0のユニットを盤面から除去

### 拠点ダメージ
- プレイヤーユニットがpos >= 20に到達 → AI拠点にatkダメージ → ユニット除去
- AIユニットがpos <= 0に到達 → プレイヤー拠点にatkダメージ → ユニット除去

## AI行動決定

### AI呼び出し頻度
- **1秒に1回**（5 tickに1回）
- サーバーまたはクライアントがレート制御

### AI入力（JSON）
```json
{
  "cost": 15.5,
  "base_hp": 80,
  "enemy_base_hp": 60,
  "my_units": [
    {"id": "u1", "pos": 18, "hp": 10, "max_hp": 15, "atk": 5, "range": 2}
  ],
  "enemy_units": [
    {"id": "e1", "pos": 5, "hp": 8, "max_hp": 10, "atk": 3, "range": 1.5}
  ],
  "hand": [
    {"unit_spec_id": "spec1", "name": "Knight", "cost": 4},
    {"unit_spec_id": "spec2", "name": "Archer", "cost": 3}
  ]
}
```

### AI出力（JSON固定）
```json
{
  "spawn_unit_spec_id": "spec1",
  "wait_ms": 600,
  "reason": "Need a tank unit to absorb damage"
}
```

- **spawn_unit_spec_id**: 召喚するユニットのID（nullの場合は召喚しない）
- **wait_ms**: 次の判断までの待機時間（600ms推奨）
- **reason**: 判断理由（ログ用）

### システムプロンプト（骨子）
```
あなたは1レーンリアルタイム対戦ゲームのAIプレイヤーです。

## ルール
- レーン: 0（プレイヤー拠点）～20（AI拠点）
- tick: 200ms
- コスト: 初期10、上限20、回復+0.6/tick
- デッキ: 5体のユニット
- 勝利条件: 敵拠点HP=0

## ユニット行動
- 自動的に敵陣に前進
- 射程内の敵を自動攻撃
- 拠点に到達すると拠点にダメージ

## 戦術目標
- 拠点を守る
- 敵拠点を削る
- コストを効率的に使う

## 出力フォーマット
以下のJSON形式のみで応答してください。
{
  "spawn_unit_spec_id": "<id or null>",
  "wait_ms": 600,
  "reason": "<理由>"
}
```

## パワースコアとコスト算出

### パワースコア計算式（1レーン用）
```
power =
  max_hp × 0.4 +
  atk × 1.4 +
  (range ** 1.5) × 8 +
  speed × 6 +
  (1 / atk_interval) × 10
```

### コスト計算式
```python
cost = clamp(ceil(power / 20), 1, 8)
```

- 最小: 1
- 最大: 8
- サーバー側で強制的に調整

## 距離計算

### 1次元距離
```python
def calculate_distance(pos1: float, pos2: float) -> float:
    return abs(pos2 - pos1)

def in_range(pos1: float, pos2: float, range: float) -> bool:
    return calculate_distance(pos1, pos2) <= range
```

### 射程の例
| 射程 | 攻撃可能な距離 |
|------|--------------|
| 1.0 | 隣接1マス |
| 2.0 | 2マス以内 |
| 3.0 | 3マス以内 |
| 5.0 | 5マス以内 |
| 7.0 | 7マス以内 |

## MVP範囲のルール確認

### MVP必須
- ✅ 1レーン（0-20の21マス）
- ✅ リアルタイムtick（200ms）
- ✅ 基本ステータス（max_hp, atk, speed, range, atk_interval）
- ✅ コスト管理（初期10、上限20、回復+0.6/tick）
- ✅ 自動移動・攻撃
- ✅ 拠点HP（初期100）
- ✅ 勝利条件（敵拠点HP=0）
- ✅ AI召喚決定（1秒に1回）

### MVP後
- ⬜ スキル（範囲攻撃、バフ/デバフ）
- ⬜ 複雑なユニット行動（後退、回避）
- ⬜ マルチレーン（2-3レーン）
- ⬜ リプレイ機能

## 参考事例

### 類似ゲーム
- **にゃんこ大戦争**: 1レーン、自動移動・攻撃、拠点戦
- **Clash Royale**: リアルタイム配置、コスト管理
- **Plants vs Zombies**: レーン戦、タワーディフェンス

### 差別化ポイント
- **プロンプト駆動**: ユーザーがユニットを自由に生成
- **AI対戦**: Mistralが盤面を見て召喚を決定
- **シンプル**: 最小限のルールで戦略性
